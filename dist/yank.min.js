"use strict";function e(e){return function(e){if(Array.isArray(e))return s(e)}(e)||i(e)||l(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=l(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,u=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){u=!0,i=e},f:function(){try{a||null==n["return"]||n["return"]()}finally{if(u)throw i}}}}function n(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function r(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){p(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e){return c(e)||i(e)||l(e)||u()}function i(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function a(e,t){return c(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,o,i=[],a=!0,u=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(i.push(r.value),!t||i.length!==t);a=!0);}catch(l){u=!0,o=l}finally{try{a||null==n["return"]||n["return"]()}finally{if(u)throw o}}return i}(e,t)||l(e,t)||u()}function u(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(e,t){if(e){if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?s(e,t):void 0}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function c(e){if(Array.isArray(e))return e}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){function e(t){var n=this;f(this,e),p(this,"reg",{get keys(){return new RegExp(",(?![^(]*[)])|(?<=".concat(e.tokens.OPEN,")"))},get scopes(){var t=e.tokens,n=t.CLOSE,r=t.OPEN;return new RegExp("(?=[".concat(n,"]+)|(?=").concat(r,")"))},get flags(){var t=Object.values(e.tokens.FLAGS).map((function(e){return"\\".concat(e)})).join("|");return new RegExp("(?=".concat(t,")"))}}),p(this,"depth",0),p(this,"tree",[]),this.schemas=t,this.tokens=this.strip().split(this.reg.keys).map((function(e){return n.tokenise(e)}))}return y(e,[{key:"nodeify",value:function(){var t=a(this.tokens.shift(),2),n=t[0],i=t[1],u=o(n.split(e.tokens.DIV)),l=u[0],s=u.slice(1);return{shift:i,node:{children:[],filters:this.filterfy(s),options:r({},e.options),key:{value:l,path:l.split(e.tokens.SEG),name:l.split(e.tokens.SEG).pop()}}}}},{key:"filterfy",value:function(e){var t=this;return e.map((function(e){var n=a(e.split(/(?=\([\w$_,]*\)|$)/g),2),r=n[0],o=n[1],i=a(r.split(t.reg.flags),2),u=i[0],l=i[1],s=null==o?void 0:o.replace(/\(([\w$_,]*)\)/g,"$1").split(",").filter(Boolean);return{name:u,args:null!=s?s:[],flag:{value:null!=l?l:null,on:function(e,t){return l===e&&t()}}}}))}},{key:"tokenise",value:function(t){var n=o(t.split(this.reg.scopes)),r=n[0],i=n.slice(1),a=this.measure(i);return r===e.tokens.CLOSE?[null,a-1]:[r,a]}},{key:"next",value:function(e){var t=this.nodeify(e),n=t.node,r=t.shift,o=this.depth;for(this.depth+=r;r>0&&this.depth>o;)this.next(n.children);n.key&&e.push(n)}},{key:"measure",value:function(t){return+t.includes(e.tokens.OPEN)||-t.length||0}},{key:"strip",value:function(){return this.schema.trim().replace(/\s+/g,(function(t,n,r){return"\n"===t&&n[r+1]!==e.tokens.CLOSE?",":""}))}},{key:"parse",value:function(){for(;this.tokens.length;)this.next(this.tree);return this.tree}},{key:"schema",get:function(){return this.schemas.join(",")}}]),e}();p(v,"options",{nullable:!1,extract:!1,exec:null}),p(v,"tokens",{OPEN:":{",CLOSE:"}",DIV:"|",SEG:".",FLAGS:{MACRO:"!"}});var d=v.tokens.FLAGS,b=function(){return null},g={as:function(e){var t=e.node,n=a(e.args,1)[0];t.key.name=n},nullable:function(e){var n=e.node,r=e.flag;n.options.nullable=!0,r.on(d.MACRO,(function(){var e,r=t(n.children);try{for(r.s();!(e=r.n()).done;){e.value.options.nullable=!0}}catch(o){r.e(o)}finally{r.f()}}))},extract:function(e){e.node.options.extract=!0},exec:function(t){var n,r=t.node,i=t.data,a=o(t.args),u=a[0],l=a.slice(1),s=null!==(n=i[u])&&void 0!==n?n:b;r.options.exec=function(t){return s.apply(void 0,[t].concat(e(l)))}}},m=function(){return new Error("All schemas must be strings")},k=function(e){return new Error('Filter "'.concat(e,'" could not be found'))};function O(e){var t=e.findIndex((function(e){return"string"!=typeof e}));if(t>=0)throw m(e[t]);return e}var w=Object.assign,S=function(){function e(t,n){f(this,e),p(this,"result",{}),this.data=t,this.ast=n}return y(e,[{key:"yank",value:function(e,t,n){this.filter({node:e,data:t,parent:n});var r=this.get(t,e.key.path,e.options),o=this.set.bind(this,e,n);if(e.children.length){if(r||e.options.nullable){var i=this.dig(e,r);e.options.extract?w(n,i):o(i)}}else o(r)}},{key:"dig",value:function(e,n){var r={},o=e.children.every((function(e){return!e.options.nullable}));if(!n&&o)return null;var i,a=t(e.children);try{for(a.s();!(i=a.n()).done;){var u=i.value;this.yank(u,n,r)}}catch(l){a.e(l)}finally{a.f()}return r}},{key:"filter",value:function(e){var n,r=t(e.node.filters);try{for(r.s();!(n=r.n()).done;){var o=n.value,i=o.name,a=o.flag,u=o.args,l=g[i],s=w(e,{flag:a,args:u});if(!l)throw k(i);l(s)}}catch(c){r.e(c)}finally{r.f()}}},{key:"serialise",value:function(){var e,n=t(this.ast);try{for(n.s();!(e=n.n()).done;){var r=e.value;this.yank(r,this.data,this.result)}}catch(o){n.e(o)}finally{n.f()}return this.result}},{key:"get",value:function(e,t,n){var r=t.reduce((function(e,t){return null==e?void 0:e[t]}),e),o=n.exec?n.exec(r):r;return n.nullable?null!=o?o:null:o}},{key:"set",value:function(e,t,n){t[e.key.name]=n}}]),e}();module.exports=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=O(n.flat()),i=new v(o),a=new S(e,i.parse());return a.serialise()};
